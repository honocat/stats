---
title: '11. 統計的検定と平均値の比較'
subtitle: ''
author: 'honocat'
date: '`r Sys.Date()`'
execute:
  echo: true
  warning: false
  message: true
format:
  pdf:
    fig-width: 5
    fig-height: 3
  html:
    fig-width: 5
    fig-height: 3
pdf-engine: lualatex
documentclass: ltjsarticle
lang: ja
---

```{r global_option}
#| include: false

if (knitr::is_latex_output()) {
  knitr::opts_chunk$set(dev = 'cairo_pdf')
}
```

```{r}
#| echo: false
#| message:  false

library(tidyverse)
my_font <- 'HiraginoSans-W3'
theme_set(theme_gray(base_size = 9,
                     base_family = my_font))
```

## 統計的検定

### 有意水準の意味を理解する：帰無仮説が正しい場合の仮説検定シミュレーション

標準正規分布に従う変数$X$について考える。つまり、

$$
X \sim \text{Normal} (0, 1)
$$

と表記される確率変数$X$を考える。

私たちが母数を知らないと仮定して、この集団からランダムに標本を抽出し、以下の仮説を検証する。

- 帰無仮説：$\mu = 0$
- 対立仮説：$\mu \ne 0 $

有意水準5%に設定し、検定を行う。実際には帰無仮説が正しいので、帰無仮説を棄却しないことが望ましい。母数を知らずに検定を行った場合、どのような結果が得られるだろうか。

#### 1つの標本で検定を行う。

まず、標本を抽出する。標本サイズ$N = 20$とする。

```{r}
N <- 20
smp_1 <- rnorm(N, mean = 0, sd = 1)
```

この標本の標本平均は、

```{r}
mean(smp_1)
```

である。この標本平均は0ではない。つまり$\bar{x} \ne 0$であるが、ここから、$\mu \ne 0$と言えるだろうか。

標本平均の分布は自由度$N - 1$の$t$分布に従うので、$t$分布を利用して検定を行う。

ある標本を利用して、「母平均が0」という帰無仮説を検証したいときは、`t.test()`という関数を使う。対立仮説が「母平均は0ではない」のときは、次のようにする。

```{r}
(res_1 <- t.test(smp_1))
```

この結果の読み方を説明する。まず、`data: smp_1`というところに、検定に利用した標本が示される。次の行を見ると、検定統計量$T$の値が`t =`で示されたあと、自由度（df）と$p$値（p-value）が表示される。検定統計量の絶対値$|T|$が、自ら決めた有意水準における臨界値の絶対値$|c|$より大きいとき、帰無仮説を棄却する。検定統計量自体は、次のように取り出せる。

```{r}
res_1$statistic
```

また、自由度$N - 1$の$t$分布で、有意水準が5%のときに必要な臨界値は、

```{r}
qt(p = 0.05 / 2, df = N - 1)
```

である。この2つの値の絶対値同士を比べると、

$$
|T| < |c|
$$

だから、帰無仮説は棄却されない。つまり、$\mu = 0$を否定する証拠はない。

実際、$\mu = 0$ということを知っているので、これは妥当な結論である。

#### 仮説検定のシミュレーション

まず、標本抽出と仮説検定を1回行い、帰無仮説（null hypothesis）を棄却しないときは**null**を、帰無仮説を棄却して対立仮説（alternative hypothesis）を採用するときは**alt**を返す関数を作る。有意水準（`level`）と標本サイズは自分で設定できるようにしておく。

```{r}
smp_test <- function(N = 10, level = 0.05) {
  ## 標本を抽出し、「母平均 = 0」という仮説を検定する関数
  ## 引数: N = 標本サイズ
  ##       level = 有意水準
  smp <- rnorm(N, mean = 0, sd = 1)
  test <- t.test(smp)
  judge <- abs(test$statistic) > abs(qt(p = level / 2, df = N - 1))
  res <- ifelse(judge, 'alt', 'null')
  return(res)
}
```

試しにこの関数を使ってみると、

```{r}
smp_test(N = 20, level = 0.05)
```

というように、1つの標本からどちらの仮説を採用したかがわかる。

標本サイズ$N = 20$、有意水準5%で、この作業を10,000回繰り返してみよう。

```{r}
n_sims <- 1e4
sim_1 <- replicate(n_sims, smp_test(N = 20, level = 0.05))
table(sim_1) / n_sims
```

対立仮説が約`r round(sum(sim_1 == 'alt') / 100, 0)`%、帰無仮説が`r round(sum(sim_1 == 'null') / 100, 0)`%の検定で採用されている。

上で$\mu = 0$と設定しているので、帰無仮説こそが正しい仮説である。しかし、帰無仮説が正しくても、誤って帰無仮説を棄却し、対立仮説を採用してしまうことがある。この誤りを「第1種の誤り（Type I error）」と呼ぶ。第1種の誤りの確率は、有意水準に一致する。私たちは有意水準5%を選んだ。

### 危険率、検出力、標本サイズ：対立仮説が正しい場合の仮説検定シミュレーション

平均2、標準偏差2の正規分布に従う変数$Y$について考える。

$$
Y \sim \text{Normal} (\mu = 2, \sigma = 2)
$$

- 帰無仮説：$\mu = 0$
- 対立仮説：$\mu \ne 0$

有意水準を5%に設定し、検定を行う。対立仮説の方が正しいので、帰無仮説を棄却したい。

#### 1つの標本で検定を行う

まず、標本を抽出する。標本サイズ$N = 20$にする。

```{r}
N <- 20
smp_2 <- rnorm(N, mean = 2, sd = 2)
mean(smp_2)
(res_2 <- t.test(smp_2))
res_2$statistic
qt(p = 0.05 / 2, df = N - 1)
```

検定統計量$T$と臨界値$c$の絶対値を比べると、

$$
|T| > |c|
$$

だから、帰無仮説は棄却される。

#### 仮説検定のシミュレーション

まず、標本抽出と仮説検定を1回行い、帰無仮説（null hypothesis）を棄却しないときは**null**を、帰無仮説を棄却して対立仮説（alternative hypothesis）を採用するときは**alt**を返す関数を作る。先程作った関数を改良し、母平均と母標準偏差も自分で設定できるようにする。

```{r}
smp_test_2 <- function(N = 10, level = 0.05, mu = 0, sigma = 1) {
  ## 標本を抽出し、「母平均 = 0」という仮説を検定する関数
  ## 引数: N = 標本サイズ
  ##       level = 有意水準
  ##       mu = 母平均
  ##       sigma = 母標準偏差
  smp <- rnorm(N, mean = mu, sd = sigma)
  test <- t.test(smp)
  judge <- abs(test$statistic) > abs(qt(p = level / 2, df = N - 1))
  res <- ifelse(judge, 'alt', 'null')
  return(res)
}
```

試しに使ってみる。

```{r}
smp_test_2(N = 20, level = 0.05, mu = 2, sigma = 2)
```

標本サイズ$N = 20$、有意水準5%で、この作業を10,000回繰り返してみる。

```{r}
n_sims <- 1e4
sim_11 <- replicate(n_sims, smp_test_2(N = 20, level = 0.05,
                                       mu = 2, sigma = 2))
table(sim_11) / n_sims
```

私たちは、上で$\mu = 2$と設定しているので、対立仮説こそが正しい仮説である。しかし、対立仮説が正しくても、帰無仮説を棄却せず、対立仮説を採用できない場合がある。この誤りのことを「第2種の誤り（Type II error）」という。

第2種の誤りの確率は、有意水準と負の相関関係を持つ。第2種の誤りを小さくするには、有意水準を大きくすれば良い。しかし、優位種順は、それ自体が第1種の誤りの確率を表しているので、有意水準を大きくするということは、第1種の誤りの確率が大き成るということ。

有意水準を変えずに、第2種の誤りの確率を小さくできるか。第2種の誤りを小さくするには、「0との違い」を見つ出す力を強めたらいい。つまり、小さな違いでも違いとして見つけ出すことができれば、帰無仮説を棄却することができるようになり、第2種の誤りの確率は小さくなる。これを**検出力（power）**という。検出力は標本サイズに依存する。

有意水準を5%にして、標本サイズを10, 20, 50, 100, 200と変えて、第2種の誤りの割合を計算してみる。

$N = 10$のとき。

```{r}
sim_14 <- replicate(n_sims, smp_test_2(N = 10, level = 0.05, mu = 2, sigma = 2))
table(sim_14) / n_sims
```

$N = 20$のとき。

```{r}
sim_15 <- replicate(n_sims, smp_test_2(N = 20, level = 0.05, mu = 2, sigma = 2))
table(sim_15) / n_sims
```

$N = 50$のとき。

```{r}
sim_15 <- replicate(n_sims, smp_test_2(N = 50, level = 0.05, mu = 2, sigma = 2))
table(sim_15) / n_sims
```

$N = 100$のとき。

```{r}
sim_16 <- replicate(n_sims, smp_test_2(N = 100, level = 0.05, mu = 2, sigma = 2))
table(sim_16) / n_sims
```

$N = 200$のとき。

```{r}
sim_17 <- replicate(n_sims, smp_test_2(N = 200, level = 0.05, mu = 2, sigma = 2))
table(sim_17) / n_sims
```

このように、標本サイズを大きくすると、第2種の誤りの確率は下がる。したがって、統計的検定における誤りの確率を減らすためには、有意水準を小さくし、標本サイズを大きくすることが重要に成る（しかし、このことは、標本サイズさえ大きくすれば、些細な違いも検出されてしまうことも意味しているので注意が必要）。

## 平均値の差の検定

2つのグループの平均値に差があるかどうか、統計的検定で判断しよう。これまで同様、`t.test()`を使って$t$検定を行う。

### 対応のないデータの平均値の差の検定

**例題**：2つのコーヒーチェーンで、どちらのコーヒーが美味しいか調べるため、無作為に選んだ10人にD店のコーヒーを、無作為に選んだ別の10人にS店のコーヒーを飲んでもらった。10点満点で点数をつけてもらったところ、次のようなデータが得られた。

```{r}
d <- c(8, 7, 8, 6, 4, 8, 9, 10, 7, 7)
s <- c(6, 10, 3, 10, 4, 4, 5, 7, 2, 6)
```

D店のコーヒーを飲んだ10人と、S店のコーヒーを飲んだ10人は異なるので、これは対応のないデータであると考えられる。

2つの店のコーヒーの味に対する評価の平均値は、

```{r}
mean(d)
mean(s)
```

であり、単純に比較すれば、D店のコーヒーの方が美味しいということになりそうである。しかし、この結果は、1つの標本から得られた結果に過ぎない。言い換えると、今回抽出された人たちは、たまたまD店の味を好んだだけかもしれない。そこで、統計的検定の方法を使って、2店の美味しさに違いがあるかどうか判断しよう。

各コーヒー店のコーヒーの味の評価の母数（パラメタ、真の値）をそれぞれ$D$と$S$とすると、今回検証する仮説は、

- 帰無仮説：$D = S$（つまり、$D - S = 0$）
- 対立仮説：$D \ne S$（つまり、$D - S \ne 0$）

ということになる。これを有意水準5%で検定する。また、2つのグループの分散は異なると仮定する。

以下のコマンドでWelchの$t$検定を実行する。

```{r}
(eg_1 <- t.test(d, s, var.equal = FALSE))
```

検定統計量は、`r eg_1$statistic`である。また、今検定に必要な$t$分布の自由度（df）は、`r eg_1$parameter`である。この自由度を使って検定に使う臨界値を求めると、

```{r}
qt(p = 0.05 / 2, df = eg_1$parameter)
```

である。$|T| < |c|$だから、帰無仮説は棄却されない。したがってD店のコーヒーの方が美味しいとは言えない。

ちなみに、`t.test()`の結果として表示される95%信頼区間から、検定結果を出すこともできる。この例では、DとSの差の95%信頼区間が表示されており、その区間が0（つまり、2つの美味しさに差がない）を含んでいるので有意水準5%で帰無仮説を棄却できない。

### 対応のあるデータの平均値の差の検定

**例題**：2つのコーヒーチェーンで、どちらのコーヒーが美味しいか調べるため、無作為に選んだ10人にD店のコーヒーとS店のコーヒーを1杯ずつ飲んでもらった。それぞれのコーヒーに10点満点で点数をつけてもらったところ、次のようなデータが得られた。

```{r}
survey <- tibble(
  id = 1 : 10,
  d = c(8, 7, 8, 6, 4, 8, 9, 10, 7, 7),
  s = c(6, 10, 3, 10, 4, 4, 5, 7, 2, 6)
)
survey
```

同じ10人がD店のコーヒーとS店のコーヒーの両方を飲んで評価しているので、これは対応のあるデータであると考えられる。

```{r}
mean(survey$d)
mean(survey$s)
```

であり、単純に比較すれば、D店のコーヒーの方が美味しいということになりそうである。しかし、この結果は、1つの標本から得られた結果に過ぎない。言い換えると、今回抽出された人たちは、たまたまD店の味を好んだだけかもしれない。そこで、統計的検定の方法を使って、2店の美味しさに違いがあるかどうか判断しよう。

各コーヒー店のコーヒーの味の評価の母数（パラメタ、真の値）をそれぞれ$D$と$S$とすると、今回検証する仮説は、

- 帰無仮説：$D = S$（つまり、$D - S = 0$）
- 対立仮説：$D \ne S$（つまり、$D - S \ne 0$）

ということになる。これを有意水準5%で検証する。対応のあるデータであることを伝えるため、`paired = TRUE`を指定する。

```{r}
(eg_2 <- t.test(survey$d, survey$s, paired = TRUE))
```

検定統計量は、`r eg_2$statistic`である。また、この検定に必要な$t$分布の自由度（df）は`r eg_2$parameter`である。この自由度を使って検定に使う臨界値を求めると、

```{r}
qt(p = 0.05 / 2, df = eg_2$parameter)
```

である。$|T| < |c|$だから、帰無仮説は棄却されない。したがって、D店のコーヒーの方が美味しいとは言えない。

95%信頼区間を見てみると、0（美味しさに差がない）を含んでいるので、帰無仮説は棄却されない。
